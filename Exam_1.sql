

--5 Create a view of all books and its NUMBER of copies that are currently available in the Library
--CREATE VIEW AVAILBOOKS AS
--SELECT B.BOOK_ID, B.TITLE,SUM(BC.NO_OF_COPIES) - (SELECT COUNT(*) 
--                                                  FROM BOOK_LENDING BL 
--                                                  WHERE BL.BOOK_ID=B.BOOK_ID
--                                                  GROUP BY BL.BOOK_ID )
--AS "AVAILQTY" FROM BOOK B, BOOK_COPIES BC 
--WHERE B.BOOK_ID=BC.BOOK_ID
--GROUP BY B.BOOK_ID,B.TITLE;

--SELECT * FROM AVAILBOOKS ;

CREATE TABLE EMPLOYEE(SSN NUMBER(3) PRIMARY KEY,
ENAME VARCHAR(20),
ADDRESS VARCHAR(20),
SEX VARCHAR(1) CHECK(SEX='M' OR SEX = 'F'),
SALARY NUMBER(10),
SUPERSSN REFERENCES EMPLOYEE ON DELETE CASCADE,
DNO NUMBER(3));

INSERT INTO EMPLOYEE VALUES(1,'ABHIJITH','UDUPI','M',650000,1,NULL);
INSERT INTO EMPLOYEE VALUES(2,'SAHIL','KATPADY','M',660000,1,NULL);
INSERT INTO EMPLOYEE VALUES(3,'THEJAS','UCCHILA','M',670000,1,NULL);
INSERT INTO EMPLOYEE VALUES(4,'SOHAIL','UJRE','M',680000,2,NULL);
INSERT INTO EMPLOYEE VALUES(5,'SNEHITH','BANTWAL','M',690000,1,NULL);
INSERT INTO EMPLOYEE VALUES(6,'AFIK','MUDIPU','M',450000,2,NULL);

CREATE TABLE DEPARTMENT(
DNO NUMBER(3) PRIMARY KEY,
DNAME VARCHAR(20),
DMGRSSN REFERENCES EMPLOYEE(SSN) ON DELETE CASCADE,
MGRSTARTDATE DATE);

ALTER TABLE EMPLOYEE ADD CONSTRAINT FK FOREIGN KEY(DNO) REFERENCES DEPARTMENT ON DELETE CASCADE;
 INSERT INTO DEPARTMENT VALUES(1,'CSE',1,'01-JAN-2020');
 INSERT INTO DEPARTMENT VALUES(2,'IOT',2,'02-JAN-2020');
 INSERT INTO DEPARTMENT VALUES(3,'ACCOUNTS',1,'03-JAN-2020');
 INSERT INTO DEPARTMENT VALUES(4,'FINANCE',2,'04-JAN-2020');
 INSERT INTO DEPARTMENT VALUES(5,'CIVIL',1,'05-JAN-2020');
 
UPDATE EMPLOYEE SET DNO=&DNO WHERE SSN=&SSN;
SELECT * FROM EMPLOYEE;

CREATE TABLE PROJECT (
PNO NUMBER(3) PRIMARY KEY,
PNAME VARCHAR(20),
PLOCATION VARCHAR(20),
DNO REFERENCES DEPARTMENT ON DELETE CASCADE
);
INSERT INTO PROJECT VALUES(1,'IOT','UDUPI',2);
INSERT INTO PROJECT VALUES(2,'ROBOTICS','UDUPI',1);
INSERT INTO PROJECT VALUES(3,'NEURAL','MANGALORE',2);
INSERT INTO PROJECT VALUES(4,'SIMULATION','UDUPI',1);
INSERT INTO PROJECT VALUES(5,'AERODYNAMICS','UDUPI',2);
INSERT INTO PROJECT VALUES(6,'GAMING','MANGALORE',4);
INSERT INTO PROJECT VALUES(7,'SAMAN','UDUPI',3);

CREATE TABLE WORKS_ON (
SSN REFERENCES EMPLOYEE ON DELETE CASCADE,
PNO REFERENCES PROJECT ON DELETE CASCADE,
HOURS NUMBER(2));

INSERT INTO WORKS_ON VALUES(1,1,2);
INSERT INTO WORKS_ON VALUES(1,2,3);
INSERT INTO WORKS_ON VALUES(1,4,4);

INSERT INTO WORKS_ON VALUES(2,1,4);
INSERT INTO WORKS_ON VALUES(2,2,1);
INSERT INTO WORKS_ON VALUES(4,3,5);
INSERT INTO WORKS_ON VALUES(3,4,3);


--1 PNO WHICH HAVE ABHIJITH AS MANAGER OR EMPLOYEE
SELECT PNO FROM WORKS_ON WHERE SSN IN(SELECT SSN FROM EMPLOYEE WHERE ENAME='ABHIJITH')
UNION
SELECT PNO FROM PROJECT WHERE DNO IN(
SELECT DNO FROM DEPARTMENT WHERE DMGRSSN IN (
SELECT SSN FROM EMPLOYEE WHERE ENAME='ABHIJITH'));

--2. iot PROJECT WORKERS ARE GIVEN 10 PERCENT RAISE
SELECT SSN , ENAME , SALARY , 1.1*SALARY FROM EMPLOYEE WHERE 
SSN IN 
(SELECT SSN FROM WORKS_ON WHERE PNO IN 
(SELECT PNO FROM PROJECT WHERE PNAME='IOT'))
;

--3. EMPLOYEE WHO WORKS ON ALL PROJECTDS CONTROLLED BY DEPARTM NO
SELECT SSN , ENAME FROM EMPLOYEE E WHERE NOT EXISTS((SELECT PNO FROM PROJECT WHERE DNO=1)
MINUS(SELECT PNO FROM WORKS_ON W WHERE E.SSN=W.SSN));

--5. COUNT SALARY ABOVE 6LAKH
SELECT DNO , COUNT(SSN) "SALARY>600000" FROM EMPLOYEE WHERE SALARY>600000 
GROUP BY(DNO)
HAVING COUNT(SSN)>2
; 